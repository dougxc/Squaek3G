/*
 * Copyright 2004 Sun Microsystems, Inc. All Rights Reserved.
 *
 * This software is the proprietary information of Sun Microsystems, Inc.
 * Use is subject to license terms.
 *
 * This is a part of the Squawk JVM.
 */
package com.sun.squawk.builder.gen;

import java.io.*;
import java.util.*;

/**
 * This is the base class for the programs that generate a source file.
 *
 * @author  Doug Simon
 */
public abstract class Generator {

    /**
     * Runs this generator to generate or update the content in a given file.
     *
     * @param dir    the base directory of the file whose content is to be generated/updated
     * @return false if <code>file</code> already existed and whose content matched
     *               that produced by this generator, true otherwise
     */
    public final boolean run(File baseDir) {
        try {
            File file = getGeneratedFile(baseDir);
            CharArrayWriter caw = new CharArrayWriter(file.exists() ? (int)file.length() : 0);
            PrintWriter out;
            // TODO: This is an ugly hack, but until such time as we want to change the API generate()
            // we will live with this.
            String oldLineSeparator = System.getProperty("line.separator");
            try {
                System.setProperty("line.separator", "\n");
                out = new PrintWriter(caw);
            } finally {
                System.setProperty("line.separator", oldLineSeparator);
            }

            generate(out);

            char[] content = caw.toCharArray();
            char[] oldContent = null;

            if (file.exists()) {
                FileReader fr = new FileReader(file);
                int length = (int) file.length();
                int n = 0;
                oldContent = new char[length];
                while (n < length) {
                    int count = fr.read(oldContent, n, length - n);
                    if (count < 0) {
                        throw new EOFException();
                    }
                    n += count;
                }
                fr.close();
            }

            if (!Arrays.equals(content, oldContent)) {
                file.delete();
                file.getParentFile().mkdirs();
                FileWriter fw = new FileWriter(file);
                fw.write(content);
                fw.close();
                file.setReadOnly();
                return true;
            } else {
                return false;
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    /**
     * Prints the standard Squawk VM copywright message.
     *
     * @param out  where to print the message
     */
    final void printCopyright(PrintWriter out) {
        out.println("/* **** GENERATED FILE -- DO NOT EDIT ****");
        out.println(" *      generated by " + this.getClass().getName());
        out.println(" *");
        out.println(" * Copyright 2004 Sun Microsystems, Inc. All Rights Reserved.");
        out.println(" *");
        out.println(" * This software is the proprietary information of Sun Microsystems, Inc.");
        out.println(" * Use is subject to license terms.");
        out.println(" *");
        out.println(" * This is a part of the Squawk JVM.");
        out.println(" */");
        out.println("");

    }

    /**
     * Pads a given string up to a given length with trailing spaces.
     * If <code>s.length() >= length</code>, then no padding is applied.
     *
     * @param s       the string to pad
     * @param length  the size to which <code>s</code> should be padded
     * @return  the padded string
     */
    static String pad(String s, int length) {
        if (s.length() < length) {
            char[] padded = new char[length];
            s.getChars(0, s.length(), padded, 0);
            Arrays.fill(padded, s.length(), padded.length, ' ');
            return new String(padded);
        } else {
            return s;
        }
    }

    /**
     * Produces the content the Generator subclass is responsible for.
     *
     * @param out  where to write the content
     */
    abstract void generate(PrintWriter out);

    /**
     * Gets the file generated/updated by this generator.
     *
     * @param baseDir  the base directory where the file will be created
     * @return  the file under <code>baseDir</code> generated/updated by this generator
     */
    public abstract File getGeneratedFile(File baseDir);

    /**
     * Test harness. Usage:
     *
     * Generator <Generator subclass> <file>
     *
     * @param args
     */
    public static void main(String[] args) throws Exception {

        Generator gen = (Generator)Class.forName("com.sun.squawk.builder.gen." + args[0]).newInstance();
        File file = new File(args[1]);
        boolean replaced = gen.run(file);
        if (replaced) {
            System.out.println("Generator replaced content in " + file);
        } else {
            System.out.println("Generator did not replace content in " + file);
        }

    }
}
